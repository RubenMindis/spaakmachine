/*
 * SPDX-FileCopyrightText: 2024 M5Stack Technology CO LTD
 *
 * SPDX-License-Identifier: MIT
 */
#include "Arduino.h"
#include "M5UnitScroll.h"

M5UnitScroll scroll;

#define BUF_SIZE 50
const int MAX_HEIGHT = 10;   // Table height in characters

int values[BUF_SIZE];

void setup()
{
    Serial.begin(115200);

    // basic, sda:gpio21, scl:gpio22
    scroll.begin(&Wire, SCROLL_ADDR, 21, 22, 400000U);

    // core2, sda:gpio32, scl:gpio33
    //croll.begin(&Wire, SCROLL_ADDR, 32, 33, 400000U);

    // cores3, sda:gpio2, scl:gpio1
    // scroll.begin(&Wire, SCROLL_ADDR, 2, 1, 400000U);

    Serial.printf("firmware version:%d, i2c address:0x%X\n", scroll.getFirmwareVersion(), scroll.getI2CAddress());
}

unsigned long t;
unsigned long lastSensorRead;
unsigned long lastTablePlot;

void loop()
{
    t = millis();

    int16_t encoder_value = scroll.getEncoderValue();
    bool btn_stauts       = scroll.getButtonStatus();
  
    // Serial.println(encoder_value);

    // if (!btn_stauts) {
    //     Serial.println("button press");
    // }

    if ((t - lastSensorRead) > 20) {

        int bufferIdx = encoder_value % BUF_SIZE; 

        float linearSensorValue = analogRead(32);

        values[bufferIdx] = linearSensorValue;

        lastSensorRead = t;
    }

    if ((t - lastTablePlot) > 500) {

        float avg = average(values);

        for (int i = 0; i < BUF_SIZE; i++) {

            Serial.print("Lo:");
            Serial.print(0); // To freeze the lower limit
            Serial.print(" Hi:");
            Serial.print(4096); // To freeze the upper limit
            Serial.print(" Avg:");
            Serial.print(avg);
            Serial.print(" Value:");

            Serial.println(values[i]);
            // Serial.println((i == 0 || i == BUF_SIZE-1) ? 1 : 0);
        }

        lastTablePlot = t;
    }
        
    // printAsciiTable(values, BUF_SIZE);
    
    delay(10);
}

float average(int values[BUF_SIZE]){
    int i;
    float sum = 0;
    float average = 0.0;

    for(i = 0; i < BUF_SIZE; i++){
        sum = sum + values[i];
    }

    average = sum/BUF_SIZE;

    return average;
}

// void printAsciiTable(int arr[], int length) {
//   // Clear screen + move cursor to top-left
//   Serial.print("\033[H\033[2J");

//   // Find max for scaling
//   int maxVal = 1;
//   for (int i = 0; i < length; i++) {
//     if (arr[i] > maxVal) maxVal = arr[i];
//   }

//   const int MAX_HEIGHT = 10;
//   int bars[length];

//   for (int i = 0; i < length; i++) {
//     bars[i] = map(arr[i], 0, maxVal, 0, MAX_HEIGHT);
//   }

//   for (int h = MAX_HEIGHT; h >= 0; h--) {
//     for (int i = 0; i < length; i++) {
//       if (bars[i] >= h) Serial.print(" █ ");
//       else Serial.print("   ");
//     }
//     Serial.println();
//   }

//   // Bottom line
//   for (int i = 0; i < length; i++) Serial.print("───");
//   Serial.println();

//   // Print heights
//   for (int i = 0; i < length; i++) Serial.printf("%3d", bars[i]);
//   Serial.println();
// }
